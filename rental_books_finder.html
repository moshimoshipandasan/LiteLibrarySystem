<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <title>貸出書籍検索システム</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      body { font-family: sans-serif; padding: 10px; }
      .container { max-width: 600px; margin: auto; }
      .form-group { margin-bottom: 15px; }
      label { display: block; margin-bottom: 5px; }
      input[type="text"] { width: 100%; padding: 8px; box-sizing: border-box; }
      button { padding: 10px 15px; cursor: pointer; margin-right: 5px; }
      #interactive.viewport { position: relative; width: 100%; height: auto; overflow: hidden; margin-top: 10px; border: 1px solid #ccc;}
      #interactive.viewport > canvas, #interactive.viewport > video { max-width: 100%; width: 100%; }
      canvas.drawing, canvas.drawingBuffer { position: absolute; left: 0; top: 0; }
      #message { margin-top: 15px; font-weight: bold; }
      #rental-records { margin-top: 20px; }
      table { width: 100%; border-collapse: collapse; margin-top: 10px; }
      th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
      th { background-color: #f2f2f2; }
      tr:hover { background-color: #f5f5f5; }
      .no-records { font-style: italic; color: #666; }
      /* デバッグログ用スタイル */
      #debug-log { margin-top: 20px; border: 1px solid #ccc; padding: 10px; background-color: #f5f5f5; max-height: 300px; overflow-y: auto; display: none; }
      #log-content { white-space: pre-wrap; font-family: monospace; font-size: 12px; }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>貸出書籍検索</h1>

      <div class="form-group">
        <label for="book-id">検索する書籍ID</label>
        <button id="scan-book-id-button">書籍IDをスキャン</button>
        <input type="text" id="book-id" name="bookId" placeholder="スキャンするか手入力してください">
        <div id="interactive" class="viewport"></div>
      </div>

      <button onclick="searchRentalRecords()">検索</button>
      <p id="message"></p>

      <div id="rental-records" style="display: none;">
        <h2>検索結果</h2>
        <div id="records-container"></div>
      </div>
      
      <!-- デバッグログ表示エリア -->
      <div id="debug-log">
        <h3>デバッグログ</h3>
        <pre id="log-content"></pre>
        <button onclick="toggleDebugLog()">ログ表示切替</button>
      </div>
    </div>

    <!-- バーコード読み取りライブラリ (QuaggaJSを使用) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script>
      let isScanning = false;

      // スキャンボタンの処理
      document.getElementById('scan-book-id-button').addEventListener('click', () => {
        toggleScanner('interactive', 'book-id');
      });

      // スキャナーの表示/非表示を切り替える関数
      function toggleScanner(targetElementId, inputFieldId) {
        const targetViewport = document.getElementById(targetElementId);
        if (!isScanning) {
          targetViewport.style.display = 'block';
          startScanner(targetElementId, inputFieldId);
          isScanning = true;
        } else {
          stopScanner(targetElementId);
          targetViewport.style.display = 'none';
          isScanning = false;
        }
      }

      function startScanner(targetElementId, inputFieldId) {
        setMessage("カメラを起動しています...");
        Quagga.init({
          inputStream : {
            name : "Live",
            type : "LiveStream",
            target: document.getElementById(targetElementId),
            constraints: {
              width: 480,
              facingMode: "environment"
            },
            area: { top: "20%", right: "10%", left: "10%", bottom: "20%" }
          },
          locator: { patchSize: "medium", halfSample: true },
          numOfWorkers: navigator.hardwareConcurrency || 4,
          decoder : { readers : [ // 書籍IDで使いそうなバーコード形式を指定
              'code_128_reader',
              'code_39_reader'
            ] },
          locate: true
        }, function(err) {
            if (err) {
                console.error(err);
                setMessage(`スキャナーの初期化に失敗: ${err.name}. カメラへのアクセスを許可してください。`);
                document.getElementById(targetElementId).style.display = 'none';
                isScanning = false;
                return;
            }
            console.log("スキャナー初期化完了");
            setMessage("バーコードをカメラに向けてください。");
            Quagga.start();
        });

        Quagga.onProcessed(function(result) { /* 描画処理は省略 */ });

        Quagga.onDetected(function(result) {
          const code = result.codeResult.code;
          console.log("バーコード検出:", code);
          document.getElementById(inputFieldId).value = code;
          setMessage(`コード「${code}」を読み取りました。`);
          stopScanner(targetElementId);
          document.getElementById(targetElementId).style.display = 'none';
          isScanning = false;
          searchRentalRecords(); // 書籍IDが読み取れたら自動的に検索
        });
      }

      function stopScanner(targetElementId) {
         if (Quagga.initialized) {
            Quagga.stop();
            const viewport = document.getElementById(targetElementId);
            if (viewport) {
              const canvas = viewport.querySelector('canvas');
              if (canvas) viewport.removeChild(canvas);
              const video = viewport.querySelector('video');
              if (video) viewport.removeChild(video);
            }
            console.log("スキャナー停止");
         }
      }

      // デバッグログの表示/非表示を切り替える関数
      function toggleDebugLog() {
        const debugLog = document.getElementById('debug-log');
        if (debugLog.style.display === 'none') {
          debugLog.style.display = 'block';
        } else {
          debugLog.style.display = 'none';
        }
      }
      
      // ログを追加する関数
      function addLog(message) {
        const logContent = document.getElementById('log-content');
        const timestamp = new Date().toLocaleTimeString();
        logContent.innerHTML += `[${timestamp}] ${message}\n`;
        document.getElementById('debug-log').style.display = 'block'; // ログがあれば表示する
        // 自動スクロール
        logContent.scrollTop = logContent.scrollHeight;
      }

      // 貸出記録を検索する関数
      function searchRentalRecords() {
        const bookId = document.getElementById('book-id').value.trim();
        if (!bookId) {
          setMessage("書籍IDを入力またはスキャンしてください。");
          return;
        }

        setMessage("貸出記録を検索中...");
        document.getElementById('rental-records').style.display = 'none';
        document.getElementById('records-container').innerHTML = '';
        
        addLog(`書籍ID [${bookId}] の貸出記録を検索します...`);
        
        google.script.run
          .withSuccessHandler((result) => {
            if (result && result.logs) {
              // ログ情報がある場合は表示
              result.logs.forEach(log => addLog(log));
            }
            
            if (result && result.records && result.records.length > 0) {
              displayRentalRecords(result.records);
              setMessage(`書籍ID [${bookId}] の貸出記録が見つかりました。`);
              addLog(`${result.records.length}件の貸出記録が見つかりました。`);
            } else {
              setMessage(`書籍ID [${bookId}] の貸出記録が見つかりませんでした。`);
              document.getElementById('rental-records').style.display = 'block';
              document.getElementById('records-container').innerHTML = '<p class="no-records">該当する貸出記録はありません。</p>';
              addLog("貸出記録が見つかりませんでした。");
            }
          })
          .withFailureHandler(error => {
            setMessage(`検索エラー: ${error.message}`);
            addLog(`エラー: ${error.message}`);
            console.error("検索エラー:", error);
          })
          .findRentalRecords(bookId);
      }

      // 貸出記録を表示する関数
      function displayRentalRecords(records) {
        const container = document.getElementById('records-container');
        
        // テーブルを作成
        let html = `
          <table>
            <thead>
              <tr>
                <th>書籍ID</th>
                <th>書籍名</th>
                <th>利用者名</th>
                <th>貸出日時</th>
                <th>返却予定日</th>
                <th>返却状況</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        // レコードごとに行を追加
        records.forEach(record => {
          // 日付をフォーマット
          const lendingDate = record.lendingDate ? new Date(record.lendingDate).toLocaleString() : 'N/A';
          const dueDate = record.dueDate ? new Date(record.dueDate).toLocaleString() : 'N/A';
          
          html += `
            <tr>
              <td>${record.bookId || 'N/A'}</td>
              <td>${record.bookTitle || 'N/A'}</td>
              <td>${record.userName || 'N/A'}</td>
              <td>${lendingDate}</td>
              <td>${dueDate}</td>
              <td>${record.status || 'N/A'}</td>
            </tr>
          `;
        });
        
        html += `
            </tbody>
          </table>
        `;
        
        container.innerHTML = html;
        document.getElementById('rental-records').style.display = 'block';
      }

      function setMessage(msg) {
        document.getElementById('message').innerText = msg;
      }

      // 初期状態ではスキャナービューポートを非表示にする
      document.getElementById('interactive').style.display = 'none';
      // 初期状態ではデバッグログを非表示にする
      document.getElementById('debug-log').style.display = 'none';

      // 書籍IDが手入力された場合にEnterキーで検索を実行
      document.getElementById('book-id').addEventListener('keypress', (event) => {
        if (event.key === 'Enter' && !isScanning) {
          searchRentalRecords();
        }
      });
    </script>
  </body>
</html>
