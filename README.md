# 図書貸出管理システム (Google Apps Script版)

これは、Google Apps Script (GAS) と Google スプレッドシートを利用した、町の小さな図書館向けのシンプルな図書貸出管理システムです。

## 機能

*   **図書貸出:**
    *   Webフォーム（スマートフォン対応）から各書籍に付与した「書籍ID」バーコードと利用者のIDバーコードをスキャン（または手入力）できます。
    *   書籍IDからスプレッドシートの「書籍DB」を参照して書籍名を取得します。
    *   利用者IDからスプレッドシートの「利用者DB」を参照して利用者名を取得します。
    *   貸出情報をスプレッドシートの「貸出記録」に記録します（貸出日時、返却予定日、返却状況含む）。
*   **図書返却:**
    *   別のWebフォームから返却する本の「書籍ID」バーコードをスキャン（または手入力）できます。
    *   該当する未返却の貸出記録を検索し、返却状況を更新、返却日時を記録します。
*   **延滞リマインダー:**
    *   返却予定日を過ぎても返却されていない図書について、利用者のメールアドレス宛にリマインドメールを自動送信します（GASトリガーによる定期実行が必要）。

## 必要なもの

*   Googleアカウント
*   Google スプレッドシート

## セットアップ手順

### 1. Google スプレッドシートの準備

このスクリプトを紐付けるGoogle スプレッドシートを用意し、以下の**3つ**のシートを作成・設定します。**シート名と列ヘッダー（1行目）は正確に設定してください。**

#### シート1: `書籍DB`

図書館の蔵書情報を管理します。各書籍にユニークな「書籍ID」を割り当て、バーコードとして印刷・貼付することを想定しています。

| 列 | ヘッダー名     | 内容                     | データ型 | 備考                                     |
|----|----------------|--------------------------|----------|------------------------------------------|
| A  | `書籍ID`       | 各書籍固有のID           | テキスト | 必須、ユニークであること                 |
| B  | `書籍名`       | 本のタイトル             | テキスト | 必須                                     |
| C  | `著者名`       | 著者名（任意）           | テキスト |                                          |
| D  | `出版社`       | 出版社名（任意）         | テキスト |                                          |
| E  | `備考`         | その他情報（任意）       | テキスト |                                          |

#### シート2: `貸出記録`

貸出と返却の履歴を記録します。

| 列 | ヘッダー名     | 内容                                       | データ型     | 備考                                     |
|----|----------------|--------------------------------------------|--------------|------------------------------------------|
| A  | `書籍ID`       | 貸出した本の書籍ID                         | テキスト     | 必須、「書籍DB」のIDと一致させる       |
| B  | `書籍名`       | 貸出した本のタイトル                       | テキスト     | 「書籍DB」から自動入力                   |
| C  | `利用者ID`     | 本を借りた利用者のID                       | テキスト     | 必須、「利用者DB」のIDと一致させる       |
| D  | `利用者名`     | 本を借りた利用者の氏名                     | テキスト     | 「利用者DB」から自動入力                 |
| E  | `貸出日時`     | 本を貸し出した日時                         | 日付/時刻    | 自動記録                                 |
| F  | `返却予定日`   | 本の返却期限日 (貸出日の14日後)            | 日付         | 自動計算                                 |
| G  | `返却状況`     | 本の返却状態 (`未返却` または `返却済`)    | テキスト     | 初期値: `未返却`、返却処理で `返却済` に |
| H  | `返却日時`     | 本が返却された日時                         | 日付/時刻    | 返却処理時に自動記録                     |

#### シート3: `利用者DB`

図書館の利用者情報を管理します。

| 列 | ヘッダー名       | 内容                               | データ型 | 備考                               |
|----|------------------|------------------------------------|----------|------------------------------------|
| A  | `利用者ID`       | 利用者固有のID                     | テキスト | 必須、貸出/返却時に入力するもの    |
| B  | `氏名`           | 利用者のフルネーム                 | テキスト | 必須                               |
| C  | `メールアドレス` | 利用者のメールアドレス             | テキスト | 延滞リマインダー送信に必須         |

### 2. Google Apps Script のデプロイ

1.  GASエディタ画面上部の「デプロイ」>「新しいデプロイ」を選択します。
2.  「種類の選択」で歯車アイコンをクリックし、「ウェブアプリ」を選択します。
3.  説明を入力します（例: 図書館貸出システム v1.0）。
4.  「ウェブアプリ」設定:
    *   **次のユーザーとして実行:** 「自分」（スクリプトをデプロイするGoogleアカウント）
    *   **アクセスできるユーザー:** 「全員」（推奨）または、利用範囲に応じて「（あなたのドメイン）の全員」などを選択します。
5.  「デプロイ」ボタンをクリックします。
6.  初回デプロイ時には、スクリプトが必要とする権限（スプレッドシートアクセス、外部APIアクセス、メール送信など）の承認を求められます。内容を確認し、「アクセスを許可」してください。
7.  デプロイが完了すると、WebアプリのURLが表示されます。このURLを控えてください。
    *   **貸出フォーム用URL:** `[表示されたWebアプリのURL]`
    *   **返却フォーム用URL:** `[表示されたWebアプリのURL]?page=return`
8.  これらのURLをQRコードに変換して図書館内に掲示するなどして、利用者がアクセスできるようにします。

### 3. 延滞リマインダーの自動実行設定 (トリガー)

1.  GASエディタ左側のメニューから時計アイコン（トリガー）を選択します。
2.  「トリガーを追加」ボタンをクリックします。
3.  以下の設定を行います:
    *   **実行する関数を選択:** `sendOverdueReminders`
    *   **実行するデプロイを選択:** `Head`
    *   **イベントのソースを選択:** `時間主導型`
    *   **時間ベースのトリガーのタイプを選択:** `日付ベースのタイマー` （または `日数ベースのタイマー`）
    *   **時刻を選択:** 毎日実行したい時刻（例: 午前1時～2時など、利用の少ない時間帯）
    *   **エラー通知設定:** 「毎日通知を受け取る」または「すぐに通知を受け取る」を選択することを推奨します。
4.  「保存」をクリックします。初回設定時には、再度権限の承認を求められる場合があります。

## 使い方

1.  **貸出:**
    *   図書館に掲示された貸出用QRコードを読み取るか、貸出用URLにアクセスします。
    *   「書籍IDをスキャン」ボタンで本に貼付されたバーコードを読み取るか、手入力します。書籍名が自動表示されます。
    *   「利用者IDをスキャン」ボタンで利用者のIDカードなどを読み取るか、手入力します。利用者名が自動表示されます。
    *   「貸出登録」ボタンを押します。
2.  **返却:**
    *   図書館に掲示された返却用QRコードを読み取るか、返却用URL (`?page=return`付き) にアクセスします。
    *   「書籍IDをスキャン」ボタンで返却する本のバーコードを読み取るか、手入力します。貸出情報が表示されます。
    *   「返却処理」ボタンを押します。

## 注意事項

*   **書籍IDの管理:** 各書籍にユニークな「書籍ID」を割り当て、それをバーコードとして印刷し、各書籍に貼り付ける作業が必要です。書籍IDはスキャンしやすいように、ある程度の桁数を持つ単純な英数字（例: `BK00001`）や、Code 128などの一般的なバーコード形式で生成すると良いでしょう。
*   「書籍DB」シートに登録されていない書籍IDが入力された場合、書籍名は取得できません。
*   利用者DBに利用者情報が存在しない、またはメールアドレスが登録されていない場合、貸出時の利用者名表示や延滞リマインダーメールの送信は行われません。
*   Google Apps Scriptには実行時間やメール送信数などに[クォータ（上限）](https://developers.google.com/apps-script/guides/services/quotas)があります。大規模な利用には向かない場合があります。

## ライセンス

[MIT License](LICENSE)

Copyright (c) 2025 Noboru Ando @ Aoyama Gakuin University
